<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•é˜…è¯»ä¿¡æ¯</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h2 {
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5568d3;
        }
    </style>
</head>
<body>
    <h1>ğŸ” é˜…è¯»ä¿¡æ¯è°ƒè¯•å·¥å…·</h1>
    
    <div class="debug-section">
        <h2>1ï¸âƒ£ æ£€æŸ¥ç”¨æˆ·å</h2>
        <p id="username-check">æ£€æŸ¥ä¸­...</p>
        <button onclick="setUsername()">è®¾ç½®æµ‹è¯•ç”¨æˆ·å</button>
    </div>
    
    <div class="debug-section">
        <h2>2ï¸âƒ£ æ£€æŸ¥LocalStorageä¸­çš„é˜…è¯»è¿›åº¦</h2>
        <p id="progress-count">æ£€æŸ¥ä¸­...</p>
        <div id="progress-list"></div>
        <button onclick="checkLocalStorage()">åˆ·æ–°æ£€æŸ¥</button>
        <button onclick="clearAllProgress()">æ¸…ç©ºæ‰€æœ‰è¿›åº¦</button>
    </div>
    
    <div class="debug-section">
        <h2>3ï¸âƒ£ æ£€æŸ¥APIå“åº”</h2>
        <p id="api-status">ç­‰å¾…æ£€æŸ¥...</p>
        <button onclick="testAPI()">æµ‹è¯•API</button>
        <pre id="api-response"></pre>
    </div>
    
    <div class="debug-section">
        <h2>4ï¸âƒ£ æµ‹è¯•é˜…è¯»ä¿¡æ¯æ˜¾ç¤º</h2>
        <p id="display-test">ç­‰å¾…æµ‹è¯•...</p>
        <button onclick="testDisplay()">æµ‹è¯•æ˜¾ç¤ºé€»è¾‘</button>
        <div id="display-result"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000/api';
        
        // æ£€æŸ¥ç”¨æˆ·å
        function checkUsername() {
            const username = localStorage.getItem('paperread_username') || 'guest';
            document.getElementById('username-check').innerHTML = 
                `<span class="success">âœ… å½“å‰ç”¨æˆ·å: <strong>${username}</strong></span>`;
            return username;
        }
        
        // è®¾ç½®æµ‹è¯•ç”¨æˆ·å
        function setUsername() {
            localStorage.setItem('paperread_username', 'guest');
            checkUsername();
            alert('å·²è®¾ç½®ç”¨æˆ·åä¸º: guest');
        }
        
        // æ£€æŸ¥LocalStorage
        function checkLocalStorage() {
            const username = checkUsername();
            const progressList = document.getElementById('progress-list');
            const progressCount = document.getElementById('progress-count');
            
            let count = 0;
            let html = '<div style="margin-top: 10px;">';
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('paperread_reading_progress_')) {
                    count++;
                    const value = localStorage.getItem(key);
                    const articleId = key.split('_').pop();
                    
                    try {
                        const data = JSON.parse(value);
                        html += `
                            <div style="padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 5px;">
                                <strong>æ–‡ç«  ID: ${articleId}</strong><br>
                                å½“å‰é¡µ: ${data.currentPage} / ${data.totalPages}<br>
                                æœ€åé˜…è¯»: ${new Date(data.lastReadAt).toLocaleString('zh-CN')}
                            </div>
                        `;
                    } catch (e) {
                        html += `
                            <div style="padding: 10px; margin: 5px 0; background: #fff3cd; border-radius: 5px;">
                                <strong class="warning">âš ï¸ æ–‡ç«  ID: ${articleId}</strong><br>
                                æ•°æ®æ ¼å¼é”™è¯¯: ${value}
                            </div>
                        `;
                    }
                }
            }
            
            html += '</div>';
            
            if (count === 0) {
                progressCount.innerHTML = '<span class="warning">âš ï¸ æ²¡æœ‰æ‰¾åˆ°é˜…è¯»è¿›åº¦æ•°æ®</span>';
                progressList.innerHTML = '<p class="warning">è¯·å…ˆæ‰“å¼€ä¸€ç¯‡æ–‡ç« è¿›è¡Œé˜…è¯»ï¼Œç„¶åå†æ£€æŸ¥</p>';
            } else {
                progressCount.innerHTML = `<span class="success">âœ… æ‰¾åˆ° ${count} æ¡é˜…è¯»è¿›åº¦è®°å½•</span>`;
                progressList.innerHTML = html;
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰è¿›åº¦
        function clearAllProgress() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é˜…è¯»è¿›åº¦å—ï¼Ÿ')) return;
            
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('paperread_reading_progress_') || key.startsWith('reading_progress_')) {
                    keys.push(key);
                }
            }
            
            keys.forEach(key => localStorage.removeItem(key));
            alert(`å·²æ¸…ç©º ${keys.length} æ¡é˜…è¯»è¿›åº¦è®°å½•`);
            checkLocalStorage();
        }
        
        // æµ‹è¯•API
        async function testAPI() {
            const username = checkUsername();
            const statusEl = document.getElementById('api-status');
            const responseEl = document.getElementById('api-response');
            
            statusEl.innerHTML = '<span class="warning">â³ è¯·æ±‚ä¸­...</span>';
            responseEl.textContent = '';
            
            try {
                const url = `${API_BASE_URL}/articles/?page=1&page_size=3&username=${username}&is_read=true`;
                statusEl.innerHTML += `<br><small>è¯·æ±‚URL: ${url}</small>`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                statusEl.innerHTML = `<span class="success">âœ… APIå“åº”æˆåŠŸ</span>`;
                statusEl.innerHTML += `<br>æ‰¾åˆ° ${data.count} ç¯‡å·²è¯»æ–‡ç« `;
                
                responseEl.textContent = JSON.stringify(data, null, 2);
                
                // æ£€æŸ¥reading_info
                if (data.results && data.results.length > 0) {
                    const hasReadingInfo = data.results.some(article => article.reading_info);
                    if (hasReadingInfo) {
                        statusEl.innerHTML += `<br><span class="success">âœ… æ–‡ç« åŒ…å«reading_infoå­—æ®µ</span>`;
                    } else {
                        statusEl.innerHTML += `<br><span class="error">âŒ æ–‡ç« ç¼ºå°‘reading_infoå­—æ®µ</span>`;
                    }
                }
                
            } catch (error) {
                statusEl.innerHTML = `<span class="error">âŒ APIè¯·æ±‚å¤±è´¥: ${error.message}</span>`;
                responseEl.textContent = error.stack;
            }
        }
        
        // æµ‹è¯•æ˜¾ç¤ºé€»è¾‘
        async function testDisplay() {
            const username = checkUsername();
            const testEl = document.getElementById('display-test');
            const resultEl = document.getElementById('display-result');
            
            testEl.innerHTML = '<span class="warning">â³ æµ‹è¯•ä¸­...</span>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/articles/?page=1&page_size=1&username=${username}&is_read=true`);
                const data = await response.json();
                
                if (!data.results || data.results.length === 0) {
                    testEl.innerHTML = '<span class="warning">âš ï¸ æ²¡æœ‰å·²è¯»æ–‡ç« ï¼Œè¯·å…ˆæ‰“å¼€ä¸€ç¯‡æ–‡ç« </span>';
                    return;
                }
                
                const article = data.results[0];
                
                // æ¨¡æ‹Ÿå‰ç«¯æ˜¾ç¤ºé€»è¾‘
                const readingProgress = getReadingProgressInfo(article.id);
                
                let html = '<div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">';
                html += `<h3>${article.title}</h3>`;
                
                if (article.reading_info || readingProgress.currentPage > 1) {
                    const lastReadTime = article.reading_info?.read_at 
                        ? formatRelativeTime(article.reading_info.read_at) 
                        : '';
                    const progressText = readingProgress.currentPage > 1 
                        ? `ç¬¬ ${readingProgress.currentPage}/${readingProgress.totalPages} é¡µ` 
                        : '';
                    
                    html += `
                        <div style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); padding: 10px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #667eea;">
                            ${lastReadTime ? `<span style="color: #667eea; font-weight: 500;">ğŸ“– ${lastReadTime}</span>` : ''}
                            ${progressText ? `<span style="color: #764ba2; font-weight: 500; padding: 2px 8px; background: rgba(255,255,255,0.7); border-radius: 12px; margin-left: 10px;">${progressText}</span>` : ''}
                        </div>
                    `;
                    testEl.innerHTML = '<span class="success">âœ… é˜…è¯»ä¿¡æ¯æ˜¾ç¤ºæ­£å¸¸</span>';
                } else {
                    html += '<p class="warning">âš ï¸ æ²¡æœ‰é˜…è¯»ä¿¡æ¯</p>';
                    testEl.innerHTML = '<span class="warning">âš ï¸ æ²¡æœ‰é˜…è¯»ä¿¡æ¯å¯æ˜¾ç¤º</span>';
                }
                
                html += '</div>';
                resultEl.innerHTML = html;
                
            } catch (error) {
                testEl.innerHTML = `<span class="error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</span>`;
            }
        }
        
        // å·¥å…·å‡½æ•°
        function getReadingProgressInfo(articleId) {
            try {
                const username = localStorage.getItem('paperread_username') || 'guest';
                const key = `paperread_reading_progress_${username}_${articleId}`;
                const progressData = localStorage.getItem(key);
                
                if (progressData) {
                    const data = JSON.parse(progressData);
                    return {
                        currentPage: data.currentPage || 1,
                        totalPages: data.totalPages || 1,
                        lastReadAt: data.lastReadAt || null
                    };
                }
            } catch (error) {
                console.error('è·å–é˜…è¯»è¿›åº¦å¤±è´¥:', error);
            }
            
            return {
                currentPage: 1,
                totalPages: 1,
                lastReadAt: null
            };
        }
        
        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'åˆšåˆš';
            if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`;
            if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
            if (diffDays < 7) return `${diffDays}å¤©å‰`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)}å‘¨å‰`;
            if (diffDays < 365) return `${Math.floor(diffDays / 30)}ä¸ªæœˆå‰`;
            return `${Math.floor(diffDays / 365)}å¹´å‰`;
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            checkUsername();
            checkLocalStorage();
        };
    </script>
</body>
</html>

