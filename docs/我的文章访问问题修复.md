# "我的"tab文章访问问题修复

## 🐛 问题描述

在"我的"tab下：
- ✅ 能看到文章列表
- ❌ 点击"预览"按钮看不到内容
- ❌ 点击"编辑"按钮看不到内容

## 🔍 问题原因

**根本原因**：API调用时没有传递`username`参数

### 详细说明

1. **用户语法文章的权限控制**
   - 后端的`UserGrammarArticleViewSet`会验证用户权限
   - 需要通过`username`参数确认用户身份
   - 只返回属于该用户的文章

2. **原有实现的问题**
   ```javascript
   // ❌ 错误：没有传递username
   const response = await fetch(`${API_BASE_URL}/user-grammar-articles/${id}/`);
   ```

3. **为什么列表能显示**
   - 列表接口(`loadArticles`)已经传递了`username`参数
   - 所以能正确显示文章列表

4. **为什么预览/编辑失败**
   - 获取单篇文章详情时没有传递`username`
   - 后端无法验证用户身份
   - 返回403或404错误

---

## ✅ 修复方案

### 修复代码

**修复预览功能**（`grammar_articles.js`）：

```javascript
async function previewArticle(id) {
    try {
        // 选择API端点
        let apiEndpoint = '';
        if (currentTab === 'grammar') {
            apiEndpoint = 'grammar-articles';
        } else if (currentTab === 'mine') {
            apiEndpoint = 'user-grammar-articles';
        }

        // ✅ 添加：获取用户名并添加到请求参数
        const username = localStorage.getItem('paperread_username') || 'guest';
        const params = new URLSearchParams({ username });

        // ✅ 修改：在URL中添加参数
        const response = await fetch(`${API_BASE_URL}/${apiEndpoint}/${id}/?${params}`);
        const article = await response.json();
        
        // ... 其余代码
    }
}
```

**修复编辑功能**（`grammar_articles.js`）：

```javascript
async function editArticle(id) {
    try {
        // 选择API端点
        let apiEndpoint = '';
        if (currentTab === 'grammar') {
            apiEndpoint = 'grammar-articles';
        } else if (currentTab === 'mine') {
            apiEndpoint = 'user-grammar-articles';
        }

        // ✅ 添加：获取用户名并添加到请求参数
        const username = localStorage.getItem('paperread_username') || 'guest';
        const params = new URLSearchParams({ username });

        // ✅ 修改：在URL中添加参数
        const response = await fetch(`${API_BASE_URL}/${apiEndpoint}/${id}/?${params}`);
        const article = await response.json();
        
        // ... 其余代码
    }
}
```

---

## 🧪 测试步骤

### 步骤1：确认用户名设置

打开浏览器开发者工具（F12），在Console中执行：

```javascript
// 检查当前用户名
console.log('用户名:', localStorage.getItem('paperread_username'));

// 如果没有，设置一个
localStorage.setItem('paperread_username', 'testuser');
```

### 步骤2：测试预览功能

1. 切换到"我的"tab
2. 确保有文章显示
3. 点击任意文章的"🔍 预览"按钮
4. **预期结果**：
   - 对话框打开
   - 显示"加载中..."
   - 然后显示完整文章内容
   - 标题、难度、分类、内容都正确显示

### 步骤3：测试编辑功能

1. 在"我的"tab下
2. 点击任意文章的"✏️ 编辑"按钮
3. **预期结果**：
   - 编辑模态框打开
   - 标题、难度、分类、内容等字段都正确填充
   - 可以修改并保存

### 步骤4：检查Network请求

在开发者工具的Network标签中检查：

**预览请求**：
```
Request URL: http://localhost:8000/api/user-grammar-articles/1/?username=testuser
Request Method: GET
Status Code: 200 OK
```

**编辑请求**：
```
Request URL: http://localhost:8000/api/user-grammar-articles/1/?username=testuser
Request Method: GET
Status Code: 200 OK
```

---

## 🔧 调试方法

### 方法1：检查Console错误

打开Console标签，查看是否有错误信息：

```javascript
// 常见错误
// 403 Forbidden - 权限不足
// 404 Not Found - 文章不存在或无权访问
// 500 Internal Server Error - 服务器错误
```

### 方法2：检查API响应

在Network标签中查看API响应：

**正确响应**：
```json
{
  "id": 1,
  "title": "测试文章",
  "content": "文章内容...",
  "difficulty": "intermediate",
  "category": "测试",
  "author": "testuser",
  "word_count": 100,
  "paragraph_count": 5
}
```

**错误响应**：
```json
{
  "detail": "Not found."
}
```
或
```json
{
  "detail": "Authentication credentials were not provided."
}
```

### 方法3：手动测试API

在浏览器中直接访问：

```
http://localhost:8000/api/user-grammar-articles/1/?username=testuser
```

应该能看到JSON格式的文章数据。

### 方法4：检查后端日志

在运行Django服务器的终端中查看日志：

```bash
# 应该看到类似的日志
GET /api/user-grammar-articles/1/?username=testuser
[25/Oct/2025 15:30:45] "GET /api/user-grammar-articles/1/?username=testuser HTTP/1.1" 200 XXX
```

---

## 📊 对比修复前后

### 修复前

| 功能 | "语法"tab | "我的"tab |
|------|-----------|-----------|
| 列表显示 | ✅ | ✅ |
| 预览 | ✅ | ❌ |
| 编辑 | ✅ | ❌ |
| 删除 | ✅ | ✅ |

### 修复后

| 功能 | "语法"tab | "我的"tab |
|------|-----------|-----------|
| 列表显示 | ✅ | ✅ |
| 预览 | ✅ | ✅ |
| 编辑 | ✅ | ✅ |
| 删除 | ✅ | ✅ |

---

## 🎯 后端权限验证逻辑

### UserGrammarArticleViewSet

```python
class UserGrammarArticleViewSet(viewsets.ModelViewSet):
    def get_queryset(self):
        """只显示当前用户的文章"""
        queryset = super().get_queryset()
        
        # 获取用户标识
        username = get_user_identifier(self.request)
        queryset = queryset.filter(author=username)
        
        return queryset
```

### get_user_identifier函数

```python
def get_user_identifier(request):
    """获取用户标识"""
    # 优先从查询参数获取用户名
    username = request.query_params.get('username', None)
    if username:
        return username
    
    # 尝试从POST数据获取
    username = request.data.get('username', None)
    if username:
        return username
    
    # 降级使用IP地址
    return get_client_ip(request)
```

**关键点**：
- 后端优先从查询参数(`?username=xxx`)获取用户名
- 如果没有username，会降级使用IP地址
- 使用IP地址会导致查询不到正确的文章（因为author存储的是用户名）

---

## 🚨 常见问题

### Q1: 修复后仍然看不到内容

**检查项**：

1. **用户名是否设置**
   ```javascript
   console.log(localStorage.getItem('paperread_username'));
   ```

2. **文章的author字段是否匹配**
   ```python
   # 在Django shell中
   from articles.models import UserGrammarArticle
   article = UserGrammarArticle.objects.get(id=1)
   print(article.author)  # 应该匹配localStorage中的用户名
   ```

3. **是否重启了Django服务器**
   - 修改后端代码后需要重启

### Q2: 语法tab的预览正常，我的tab不正常

**原因**：
- 语法文章不需要用户权限验证
- 用户文章需要验证

**解决**：
- 确保"我的"tab下的文章author与当前用户名匹配

### Q3: Network显示403错误

**原因**：
- 用户无权访问该文章
- 文章的author与请求的username不匹配

**解决**：
1. 检查文章的author
2. 检查请求的username参数
3. 确认两者一致

### Q4: Network显示404错误

**原因**：
- 文章不存在
- 或当前用户无此文章（被过滤掉了）

**解决**：
1. 确认文章ID正确
2. 检查文章的author字段
3. 验证数据库中文章存在

---

## ✅ 验证清单

修复完成后，请确认：

- [ ] 预览功能在"语法"tab下正常工作
- [ ] 预览功能在"我的"tab下正常工作
- [ ] 编辑功能在"语法"tab下正常工作
- [ ] 编辑功能在"我的"tab下正常工作
- [ ] Network请求包含username参数
- [ ] API返回200状态码
- [ ] 内容完整显示（标题、正文、难度等）
- [ ] 不同用户看到不同的文章

---

## 🔐 安全说明

### 当前实现的安全性

**优点**：
- 前后端双重验证
- 后端强制按用户过滤
- 用户只能访问自己的文章

**注意事项**：
- username存储在localStorage，可被修改
- 建议未来升级为真正的用户认证系统（JWT/Session）

### 未来改进建议

1. **实现真正的用户认证**
   ```python
   # 使用Django的用户系统
   from django.contrib.auth.models import User
   from rest_framework.permissions import IsAuthenticated
   
   class UserGrammarArticleViewSet(viewsets.ModelViewSet):
       permission_classes = [IsAuthenticated]
       
       def get_queryset(self):
           return UserGrammarArticle.objects.filter(
               author=self.request.user
           )
   ```

2. **添加JWT令牌**
   - 用户登录后获取token
   - 每次请求携带token
   - 后端验证token有效性

3. **添加权限检查**
   - 编辑/删除前验证所有权
   - 防止越权访问

---

**修复日期**：2025-10-25  
**版本**：v1.1  
**状态**：✅ 已修复

