# 语法文章"我的"tab调试指南

## 🐛 问题：我的tab下的文章不显示

### 快速修复步骤

#### 1️⃣ 重启Django服务器

修改了后端代码后，必须重启服务器：

```bash
# 停止当前服务器（Ctrl+C）
# 然后重新启动
cd /Users/guolei/work/local/stpython/paperread
python3 manage.py runserver
```

#### 2️⃣ 检查用户名设置

打开浏览器开发者工具（F12），在Console中执行：

```javascript
// 检查当前用户名
console.log('当前用户名:', localStorage.getItem('paperread_username'));

// 如果没有，设置一个
localStorage.setItem('paperread_username', 'testuser');

// 刷新页面
location.reload();
```

#### 3️⃣ 运行测试脚本

在终端执行：

```bash
cd /Users/guolei/work/local/stpython/paperread
python3 test_user_grammar.py
```

这个脚本会：
- 显示所有用户语法文章
- 为测试用户创建示例文章
- 验证数据隔离是否正常

#### 4️⃣ 测试创建文章

1. 打开 `http://localhost:8000/grammar_articles.html`
2. 切换到"我的"tab
3. 点击"新建文章"
4. 填写：
   - 标题：`测试文章`
   - 难度：`中级`
   - 分类：`测试`
   - 内容：`This is a test article.`
5. 点击"保存"
6. 查看文章是否显示

---

## 🔍 详细调试步骤

### 步骤1：检查前端配置

**打开浏览器Console（F12），执行：**

```javascript
// 1. 检查当前tab
console.log('当前tab:', currentTab);

// 2. 检查用户名
console.log('用户名:', localStorage.getItem('paperread_username'));

// 3. 检查API调用
// 切换到"我的"tab后，观察Network标签中的请求
```

**预期结果：**
- `currentTab` 应该是 `'mine'`
- 用户名不应该为空
- API请求应该是 `/api/user-grammar-articles/`

### 步骤2：检查Network请求

1. **打开Network标签**
2. **切换到"我的"tab**
3. **查找 `user-grammar-articles` 请求**

**检查请求：**

```
Request URL: http://localhost:8000/api/user-grammar-articles/?page=1&page_size=10&username=testuser
Request Method: GET
Status Code: 200 OK
```

**检查响应：**

```json
{
  "count": 1,
  "next": null,
  "previous": null,
  "results": [
    {
      "id": 1,
      "title": "测试文章",
      "author": "testuser",
      ...
    }
  ]
}
```

### 步骤3：检查创建请求

**在"我的"tab下创建文章时，检查POST请求：**

```
Request URL: http://localhost:8000/api/user-grammar-articles/
Request Method: POST
Content-Type: application/json
```

**请求体应该包含：**

```json
{
  "title": "测试文章",
  "content": "This is a test article.",
  "difficulty": "intermediate",
  "category": "测试",
  "source": null,
  "author": "testuser"
}
```

**重点检查：**
- ✅ `author` 字段应该存在
- ✅ `author` 值应该是当前用户名
- ✅ 不是 `guest` 或空值

### 步骤4：后端数据库检查

**打开Django shell：**

```bash
python3 manage.py shell
```

**执行以下命令：**

```python
from articles.models import UserGrammarArticle

# 查看所有用户语法文章
articles = UserGrammarArticle.objects.all()
print(f"总共 {articles.count()} 篇文章")

# 查看每篇文章的作者
for article in articles:
    print(f"ID: {article.id}, 标题: {article.title}, 作者: {article.author}")

# 查看特定用户的文章
user_articles = UserGrammarArticle.objects.filter(author='testuser')
print(f"\ntestuser 有 {user_articles.count()} 篇文章")

# 退出
exit()
```

### 步骤5：API测试

**使用curl测试API：**

```bash
# 1. 获取用户文章列表（替换testuser为你的用户名）
curl "http://localhost:8000/api/user-grammar-articles/?username=testuser"

# 2. 创建新文章
curl -X POST http://localhost:8000/api/user-grammar-articles/ \
  -H "Content-Type: application/json" \
  -d '{
    "title": "curl测试文章",
    "content": "This is a test article created by curl.",
    "difficulty": "intermediate",
    "category": "测试",
    "author": "testuser"
  }'

# 3. 再次获取列表，验证文章是否创建成功
curl "http://localhost:8000/api/user-grammar-articles/?username=testuser"
```

---

## 🛠️ 常见问题和解决方案

### 问题1：文章创建成功但不显示

**原因：** 创建时的用户名与查询时的用户名不一致

**解决方法：**

```javascript
// 在Console中检查
const createUsername = localStorage.getItem('paperread_username');
console.log('创建时的用户名:', createUsername);

// 清除并重新设置
localStorage.setItem('paperread_username', 'myusername');
location.reload();
```

### 问题2：显示"加载中..."但没有内容

**原因：** API请求失败或返回空数据

**解决方法：**

1. 检查Console是否有错误
2. 查看Network标签中的请求状态
3. 验证后端服务器是否运行
4. 检查API端点是否正确

### 问题3：文章保存到了错误的表

**原因：** 在"语法"tab下创建的文章保存到了grammar_articles表

**解决方法：**

```javascript
// 确认当前tab
console.log('当前tab:', currentTab);

// 如果不正确，手动切换到"我的"tab
document.querySelector('.tab-btn[data-tab="mine"]').click();
```

### 问题4：后端返回404错误

**原因：** API端点配置错误

**解决方法：**

检查 `articles/urls.py`：

```python
router.register(r'user-grammar-articles', UserGrammarArticleViewSet)
```

确认端点注册正确，然后重启服务器。

### 问题5：author字段为空或guest

**原因：** localStorage中没有设置用户名

**解决方法：**

```javascript
// 设置用户名
localStorage.setItem('paperread_username', 'myusername');

// 或在个人中心设置
window.location.href = 'profile.html';
```

---

## ✅ 验证清单

创建和查看文章前，请确认：

- [ ] Django服务器正在运行
- [ ] 浏览器localStorage中有paperread_username
- [ ] 在"我的"tab下操作
- [ ] Network请求指向/api/user-grammar-articles/
- [ ] POST请求包含author字段
- [ ] author字段值与localStorage中的用户名一致

---

## 🎯 完整测试流程

### 1. 设置用户名

```javascript
// 在浏览器Console中
localStorage.setItem('paperread_username', 'testuser');
location.reload();
```

### 2. 运行后端测试

```bash
python3 test_user_grammar.py
```

### 3. 创建文章

1. 打开语法文章页面
2. 切换到"我的"tab
3. 点击"新建文章"
4. 填写内容
5. 保存

### 4. 验证显示

1. 文章应该立即显示在列表中
2. 刷新页面，文章仍然存在
3. 切换到"语法"tab，文章不应该显示
4. 切换回"我的"tab，文章应该显示

### 5. 测试数据隔离

```javascript
// 更改用户名
localStorage.setItem('paperread_username', 'anotheruser');
location.reload();

// 切换到"我的"tab，应该看不到之前的文章
```

---

## 📞 还是无法解决？

### 提供以下信息：

1. **浏览器Console的错误信息**
2. **Network标签中的请求和响应**
3. **Django服务器的日志输出**
4. **test_user_grammar.py的执行结果**

### 检查命令：

```bash
# 1. 检查数据库
python3 manage.py dbshell
sqlite> SELECT * FROM user_grammar_articles;
sqlite> .exit

# 2. 检查迁移状态
python3 manage.py showmigrations articles

# 3. 检查服务器日志
# 查看运行python3 manage.py runserver的终端输出
```

---

**更新日期**：2025-10-25  
**版本**：v1.0

