# 智能分页功能说明

## 📖 功能概述

智能分页功能根据**内容长度**而非固定段落数进行分页，确保每页内容长度均衡，提供更好的阅读体验。

## ✨ 核心特性

### 1. 两种分页模式

#### 🎯 智能分页（推荐）✨
- **按字符数分页**：每页内容长度更加均衡
- **保持段落完整性**：不会截断段落
- **灵活可配置**：5个参数精确控制分页效果

#### 📏 固定段落分页
- **传统方式**：每页显示固定数量的段落
- **兼容旧版**：保持原有使用习惯

### 2. 智能分页算法

系统根据以下条件自动分页：

```
分页条件（满足任一即分页）：
1. 达到最大段落数（避免段落过多）
2. 加上当前段落会超过最大字符数（控制上限）
3. 已达到目标字符数且至少有最少段落数（理想长度）
```

**示例效果**：
```
传统固定分页（8段/页）：
第1页: 8段 → 400字   ❌ 太短
第2页: 8段 → 1600字  ✅ 正常
第3页: 8段 → 4000字  ❌ 太长

智能分页（按字符数）：
第1页: 5段 → 3800字  ✅ 均衡
第2页: 7段 → 4200字  ✅ 均衡
第3页: 6段 → 3900字  ✅ 均衡
```

## ⚙️ 参数配置

### 智能分页参数

| 参数 | 默认值 | 范围 | 说明 |
|------|--------|------|------|
| **目标字符数** | 4000 | 2000-10000 | 每页理想长度（阅读5-8分钟）|
| **最少字符数** | 2000 | 1000-5000 | 避免页面太短 |
| **最多字符数** | 8000 | 5000-15000 | 避免页面太长 |
| **最少段落数** | 2 | 1-5 | 避免单段过长 |
| **最多段落数** | 15 | 5-30 | 避免段落过多 |

### 参数约束

系统会自动验证参数合理性：
- ✅ 最少字符数 < 目标字符数 < 最多字符数
- ✅ 最少段落数 < 最多段落数

## 🛠️ 使用方法

### 1. 在系统设置中配置

1. 打开 **⚙️ 系统设置**
2. 找到 **📚 学习设置** 部分
3. 选择 **分页模式**：
   - **智能分页（按字符数）✨**（推荐）
   - 固定段落分页
4. 调整智能分页参数（如果选择智能分页）
5. 刷新阅读页面生效

### 2. 参数调整建议

#### 快速阅读（较短页面）
```
目标字符数: 3000
最少字符数: 1500
最多字符数: 5000
最少段落数: 2
最多段落数: 10
```

#### 标准阅读（推荐设置）⭐
```
目标字符数: 4000（默认）
最少字符数: 2000
最多字符数: 8000
最少段落数: 2
最多段落数: 15
```

#### 深度阅读（较长页面）
```
目标字符数: 6000
最少字符数: 3000
最多字符数: 10000
最少段落数: 3
最多段落数: 20
```

## 📊 实现原理

### 后端智能分页算法

```python
def _smart_paginate(paragraphs, target_chars, min_chars, 
                   max_chars, min_paragraphs, max_paragraphs):
    """智能分页算法"""
    pages = []
    current_page = []
    current_length = 0
    
    for paragraph in paragraphs:
        para_length = len(paragraph.strip())
        
        # 判断是否应该分页
        should_paginate = False
        
        # 条件1：达到最大段落数
        if len(current_page) >= max_paragraphs:
            should_paginate = True
        
        # 条件2：加上当前段落会超过最大字符数
        elif current_length + para_length > max_chars and len(current_page) >= min_paragraphs:
            should_paginate = True
        
        # 条件3：已达到目标字符数且至少有最少段落数
        elif (len(current_page) >= min_paragraphs and 
              current_length >= target_chars):
            should_paginate = True
        
        # 执行分页
        if should_paginate and current_page:
            pages.append(current_page)
            current_page = []
            current_length = 0
        
        current_page.append(paragraph)
        current_length += para_length
    
    # 添加最后一页
    if current_page:
        pages.append(current_page)
    
    return pages
```

### API 调用方式

#### 智能分页请求
```javascript
GET /api/articles/{id}/content_paginated/?page=1&mode=smart&target_chars=4000&min_chars=2000&max_chars=8000&min_paragraphs=2&max_paragraphs=15
```

#### 固定分页请求
```javascript
GET /api/articles/{id}/content_paginated/?page=1&mode=fixed&page_size=8
```

#### 响应数据
```json
{
  "current_page": 1,
  "total_pages": 5,
  "total_paragraphs": 35,
  "paragraphs": ["段落1...", "段落2..."],
  "has_next": true,
  "has_previous": false,
  "page_info": {
    "paragraph_count": 7,
    "char_count": 4050,
    "pagination_mode": "smart"
  },
  "article_id": 1,
  "article_title": "文章标题",
  "word_count": 1500,
  "paragraph_count": 35
}
```

## 🎯 应用场景

### ✅ 适合智能分页的场景

1. **段落长度不均匀的文章**
   - 新闻报道（有长有短）
   - 技术文档（代码+解释）
   - 小说（对话+描述）

2. **长篇内容**
   - 书籍章节
   - 学术论文
   - 深度分析

3. **追求阅读体验的用户**
   - 每页阅读时间相近
   - 翻页频率一致
   - 更好的节奏感

### ⚠️ 可能不适合的场景

1. **段落本身就很均匀的内容**
   - 诗歌（每段长度相似）
   - 列表式内容

2. **特别短的文章**
   - 少于5段的内容
   - 固定分页可能更简单

## 💡 使用技巧

### 1. 根据文章类型调整参数

- **短文章**（<20段）：降低目标字符数（3000-4000）
- **长文章**（>50段）：提高目标字符数（5000-6000）
- **技术文档**：增大最多段落数（20-25）
- **小说故事**：保持默认设置

### 2. 跨设备一致性

智能分页参数保存在 `localStorage`，确保：
- ✅ 同一设备不同会话保持一致
- ✅ 修改后刷新页面立即生效
- ✅ 切换模式时自动保存

### 3. 性能优化

- 后端预先计算分页
- 客户端只请求当前页
- 响应数据包含完整分页信息
- 支持快速翻页

## 🔧 技术实现

### 前端
- **配置管理**：`settings.js`
- **UI界面**：`settings.html` + `settings.css`
- **API调用**：`script.js` + `grammar.js`

### 后端
- **分页算法**：`articles/views.py` → `_smart_paginate()`
- **API接口**：`ArticleViewSet.content_paginated()`
- **支持文章**：普通文章 + 语法文章

## 🐛 故障排查

### 问题1：修改参数后未生效

**解决方法**：
1. 检查系统设置页面是否显示"设置已保存"提示
2. 刷新阅读页面（F5）
3. 清除浏览器缓存后重试

### 问题2：每页内容仍然不均衡

**可能原因**：
- 参数范围设置过大（如 min=1000, max=10000）
- 最少段落数设置为1

**解决方法**：
- 缩小字符数范围（如 2000-8000）
- 设置最少段落数为2或3

### 问题3：页数突然变化

**正常现象**：
- 修改分页参数后，总页数会重新计算
- 智能分页会根据内容动态调整

**注意**：
- 用户的阅读进度（当前页）会自动保持
- 标注和翻译不受影响

## 📈 未来规划

- [ ] 支持基于阅读时间的分页
- [ ] AI 预测最佳分页点
- [ ] 个性化分页推荐
- [ ] 分页效果可视化预览

## 💬 反馈建议

如有问题或建议，请在系统设置页面点击"更新日志"反馈。

---

**最后更新**：2025-10-25  
**版本**：v1.0.0

