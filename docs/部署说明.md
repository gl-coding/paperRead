# 英文文章阅读器 - 完整部署说明

## 📦 项目结构

```
paperread/
├── backend/                 # Django项目配置
│   ├── __init__.py
│   ├── settings.py         # 配置文件
│   ├── urls.py             # 主路由
│   └── wsgi.py
├── articles/               # 文章应用
│   ├── models.py          # 数据模型
│   ├── serializers.py     # 序列化器
│   ├── views.py           # 视图
│   ├── urls.py            # 路由
│   └── admin.py           # 管理后台
├── manage.py              # Django管理脚本
├── requirements.txt       # Python依赖
├── index.html            # 前端页面
├── script.js             # 前端脚本
└── style.css             # 前端样式
```

## 🚀 快速部署

### 步骤1: 数据库迁移

```bash
cd /Users/guolei/work/local/stpython/paperread
python manage.py makemigrations
python manage.py migrate
```

### 步骤2: 创建管理员账号

```bash
python manage.py createsuperuser
```

按提示输入：
- 用户名
- 邮箱
- 密码

### 步骤3: 启动后端服务器

```bash
python manage.py runserver
```

后端运行在：http://localhost:8000

### 步骤4: 访问前端

直接打开 `index.html` 文件，或者使用简单的HTTP服务器：

```bash
# 方式1：使用Python
python -m http.server 8080

# 方式2：使用其他HTTP服务器
# 然后访问 http://localhost:8080
```

## 📡 API测试

### 测试后端是否运行

访问：http://localhost:8000/api/articles/

应该看到一个JSON响应（可能是空列表）。

### 访问管理后台

访问：http://localhost:8000/admin/

使用刚才创建的管理员账号登录。

## 📝 添加示例文章

### 方式1：通过管理后台

1. 访问 http://localhost:8000/admin/
2. 点击"文章" → "添加文章"
3. 填写：
   - 标题：The Importance of AI
   - 内容：粘贴英文文章
   - 难度：选择 intermediate
   - 分类：Technology
4. 点击"保存"

### 方式2：通过API

```bash
curl -X POST http://localhost:8000/api/articles/ \
  -H "Content-Type: application/json" \
  -d '{
    "title": "The Future of AI",
    "content": "Artificial intelligence is rapidly evolving...",
    "difficulty": "intermediate",
    "category": "Technology"
  }'
```

### 方式3：通过Django Shell

```bash
python manage.py shell
```

```python
from articles.models import Article

Article.objects.create(
    title="Sample Article",
    content="This is a sample article...",
    difficulty="beginner",
    category="General"
)
```

## 🔄 修改前端连接后端

需要修改 `script.js`，添加API调用功能。创建一个新的API模块：

```javascript
// 在script.js顶部添加
const API_BASE_URL = 'http://localhost:8000/api';

// 获取文章列表
async function fetchArticles() {
    const response = await fetch(`${API_BASE_URL}/articles/`);
    return await response.json();
}

// 获取文章详情
async function fetchArticle(id) {
    const response = await fetch(`${API_BASE_URL}/articles/${id}/`);
    return await response.json();
}

// 保存阅读历史
async function saveReadingHistory(articleId, duration) {
    await fetch(`${API_BASE_URL}/articles/${articleId}/record_reading/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ read_duration: duration })
    });
}

// 保存标注
async function saveAnnotations(articleId, annotations) {
    await fetch(`${API_BASE_URL}/articles/${articleId}/save_annotations/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ annotations })
    });
}

// 获取标注
async function loadAnnotations(articleId) {
    const response = await fetch(`${API_BASE_URL}/articles/${articleId}/annotations/`);
    return await response.json();
}
```

## 🎯 功能整合建议

### 1. 添加文章选择器

在HTML中添加：

```html
<div class="article-selector">
    <label>选择文章：</label>
    <select id="articleSelect">
        <option value="">加载中...</option>
    </select>
</div>
```

### 2. 从后端加载文章列表

```javascript
// 页面加载时获取文章列表
async function loadArticleList() {
    const data = await fetchArticles();
    const select = document.getElementById('articleSelect');
    select.innerHTML = '<option value="">请选择文章</option>';
    
    data.results.forEach(article => {
        const option = document.createElement('option');
        option.value = article.id;
        option.textContent = article.title;
        select.appendChild(option);
    });
}

// 选择文章时加载内容
document.getElementById('articleSelect').addEventListener('change', async (e) => {
    const articleId = e.target.value;
    if (articleId) {
        const article = await fetchArticle(articleId);
        articleInput.value = article.content;
        handleArticleInput();
        
        // 加载之前的标注
        const annotations = await loadAnnotations(articleId);
        // 恢复标注...
    }
});
```

### 3. 自动保存标注

```javascript
// 在标注更改时自动保存
async function autoSaveAnnotations() {
    const articleId = getCurrentArticleId();
    if (articleId && annotatedWords.size > 0) {
        const annotations = Array.from(annotatedWords.entries()).map(([word, color]) => ({
            word,
            color
        }));
        await saveAnnotations(articleId, annotations);
    }
}

// 在toggleAnnotation函数中添加
function toggleAnnotation(word) {
    // ... 原有代码 ...
    
    // 自动保存
    autoSaveAnnotations();
}
```

## 🔧 开发环境vs生产环境

### 开发环境（当前）
- Debug模式开启
- 使用SQLite数据库
- 允许所有CORS来源
- SECRET_KEY暴露

### 生产环境需要修改

1. **settings.py**:
```python
DEBUG = False
ALLOWED_HOSTS = ['yourdomain.com']
CORS_ALLOWED_ORIGINS = [
    'https://yourdomain.com',
]
```

2. **使用环境变量**:
```python
import os
SECRET_KEY = os.environ.get('DJANGO_SECRET_KEY')
```

3. **使用生产数据库**（PostgreSQL推荐）

4. **配置静态文件服务**

5. **使用Gunicorn/uWSGI + Nginx**

## 📊 数据库管理

### 查看数据

```bash
python manage.py shell
```

```python
from articles.models import Article, ReadingHistory, Annotation

# 查看所有文章
Article.objects.all()

# 查看某篇文章的阅读历史
ReadingHistory.objects.filter(article_id=1)

# 查看某篇文章的标注
Annotation.objects.filter(article_id=1)
```

### 清空数据

```python
# 清空所有文章
Article.objects.all().delete()

# 清空阅读历史
ReadingHistory.objects.all().delete()

# 清空标注
Annotation.objects.all().delete()
```

## 🐛 常见问题

### 1. CORS错误

确保 `django-cors-headers` 已安装，并在 settings.py 中正确配置。

### 2. 数据库locked

SQLite在高并发时可能出现此问题，考虑使用PostgreSQL。

### 3. 静态文件404

开发环境下Django会自动处理，生产环境需要配置。

### 4. API返回404

检查URL配置是否正确，确保articles应用已注册。

## 🎉 完成！

现在你有一个完整的前后端分离的英文文章阅读器：

✅ Django REST API后端
✅ 数据库存储文章
✅ 用户标注保存
✅ 阅读历史追踪
✅ 管理后台
✅ 完整的前端界面

开始使用吧！

