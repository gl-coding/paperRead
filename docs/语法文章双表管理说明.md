# 语法文章双表管理说明

## 📋 功能概述

语法文章页面现在使用两个独立的数据库表来分别管理"语法"和"我的"两个tab下的文章：

- **语法文章表** (`grammar_articles`)：存储系统管理的语法教学文章
- **用户语法文章表** (`user_grammar_articles`)：存储用户创建的语法文章

## 🗂️ 数据库结构

### 1. GrammarArticle（语法文章表）

**表名**：`grammar_articles`

**字段**：
| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| title | CharField(200) | 文章标题 |
| content | TextField | 文章内容 |
| source | CharField(200) | 来源（可选） |
| difficulty | CharField(20) | 难度：beginner/intermediate/advanced |
| category | CharField(50) | 分类（可选） |
| word_count | Integer | 单词数（自动计算） |
| paragraph_count | Integer | 段落数（自动计算） |
| paragraphs | JSONField | 段落数据 |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |
| is_active | Boolean | 是否启用 |
| author | CharField(50) | 作者（默认'admin'） |

**特点**：
- 系统管理员创建和维护
- 所有用户可见
- 默认作者为'admin'

### 2. UserGrammarArticle（用户语法文章表）

**表名**：`user_grammar_articles`

**字段**：与 `GrammarArticle` 完全相同

**特点**：
- 用户自己创建和管理
- 只显示当前用户的文章（按author筛选）
- 作者字段自动设置为当前用户名

## 🔌 API 端点

### 语法文章 API

**基础URL**：`/api/grammar-articles/`

**支持的操作**：
- `GET /api/grammar-articles/` - 获取语法文章列表
- `GET /api/grammar-articles/{id}/` - 获取单篇语法文章
- `POST /api/grammar-articles/` - 创建语法文章（管理员）
- `PUT /api/grammar-articles/{id}/` - 更新语法文章（管理员）
- `DELETE /api/grammar-articles/{id}/` - 删除语法文章（管理员）
- `POST /api/grammar-articles/generate_content/` - AI生成内容

**查询参数**：
- `page` - 页码
- `page_size` - 每页数量
- `search` - 搜索关键词（标题/内容/分类）
- `difficulty` - 难度筛选
- `category` - 分类筛选

### 用户语法文章 API

**基础URL**：`/api/user-grammar-articles/`

**支持的操作**：
- `GET /api/user-grammar-articles/` - 获取当前用户的语法文章列表
- `GET /api/user-grammar-articles/{id}/` - 获取单篇用户语法文章
- `POST /api/user-grammar-articles/` - 创建用户语法文章
- `PUT /api/user-grammar-articles/{id}/` - 更新用户语法文章
- `DELETE /api/user-grammar-articles/{id}/` - 删除用户语法文章
- `POST /api/user-grammar-articles/generate_content/` - AI生成内容

**查询参数**：同语法文章API

**权限**：
- 自动按当前用户名（`author`）筛选
- 只能操作自己创建的文章

## 💻 前端实现

### Tab切换逻辑

```javascript
let currentTab = 'grammar'; // 或 'mine'

async function loadArticles(page = 1) {
    // 根据当前tab选择不同的API端点
    let apiUrl = '';
    if (currentTab === 'grammar') {
        apiUrl = `${API_BASE_URL}/grammar-articles/`;
    } else if (currentTab === 'mine') {
        apiUrl = `${API_BASE_URL}/user-grammar-articles/`;
    }
    
    // 调用API...
}
```

### 文章操作

**创建/更新/删除**：
- 所有操作都会根据当前tab自动选择正确的API端点
- `grammar` tab → `/api/grammar-articles/`
- `mine` tab → `/api/user-grammar-articles/`

**AI生成**：
- 两个tab都使用各自的 `generate_content` 端点
- 配置和使用方式完全相同

## 🔄 数据隔离

### 语法文章（Grammar Articles）
✅ 所有用户可见  
✅ 系统统一管理  
✅ 通常由管理员创建  
✅ 作为教学资源共享  

### 用户语法文章（User Grammar Articles）
✅ 只显示当前用户创建的文章  
✅ 用户独立管理  
✅ 自动绑定到创建者  
✅ 完全隔离，互不干扰  

## 📝 使用示例

### 场景1：系统添加语法教学文章

1. 以管理员身份登录Django Admin
2. 进入"语法文章"(Grammar Articles)管理
3. 添加新的语法文章
4. 所有用户在"语法"tab下可见

### 场景2：用户创建个人语法笔记

1. 用户打开"语法文章"页面
2. 切换到"我的"tab
3. 点击"新建文章"
4. 填写内容并保存
5. 文章只在该用户的"我的"tab下显示

### 场景3：AI生成语法文章

无论在哪个tab：
1. 点击"新建文章"
2. 输入AI提示词
3. 点击"生成内容"
4. 系统根据当前tab调用对应的API
5. 生成的内容自动填充

## 🗄️ 数据库迁移

### 创建迁移文件

```bash
python3 manage.py makemigrations articles
```

### 应用迁移

```bash
python3 manage.py migrate
```

### 迁移内容

本次迁移将创建两张新表：
- `grammar_articles`
- `user_grammar_articles`

原有的 `articles` 表不受影响。

## 🔧 管理后台

### Django Admin配置

两个模型都已注册到Django Admin：

**语法文章管理**：
- 列表显示：标题、难度、分类、字数、创建时间、状态、作者
- 筛选：难度、分类、状态、创建时间
- 搜索：标题、内容、作者
- 分组字段：基本信息、分类信息、统计信息、状态

**用户语法文章管理**：
- 额外筛选：作者（可以查看所有用户的文章）
- 其他配置同语法文章

访问地址：`http://localhost:8000/admin/`

## 📊 数据统计

### 查看语法文章总数

```python
from articles.models import GrammarArticle
total = GrammarArticle.objects.filter(is_active=True).count()
```

### 查看某用户的文章数

```python
from articles.models import UserGrammarArticle
user_articles = UserGrammarArticle.objects.filter(
    author='username',
    is_active=True
).count()
```

### 按分类统计

```python
from django.db.models import Count

# 语法文章按分类统计
GrammarArticle.objects.values('category').annotate(
    count=Count('id')
).order_by('-count')

# 用户文章按作者统计
UserGrammarArticle.objects.values('author').annotate(
    count=Count('id')
).order_by('-count')
```

## 🚀 优势

### 1. 数据隔离
- 系统文章和用户文章完全分离
- 不会相互干扰
- 便于权限管理

### 2. 性能优化
- 用户查询只检索自己的文章
- 查询效率更高
- 索引更有效

### 3. 灵活管理
- 系统文章可以设置不同的管理策略
- 用户文章可以有独立的配额控制
- 便于未来功能扩展

### 4. 清晰的职责分离
- 系统文章：教学资源
- 用户文章：个人笔记/练习

## ⚠️ 注意事项

### 1. API端点选择
前端必须根据当前tab正确选择API端点，否则会出现404错误。

### 2. 用户标识
- 确保 `localStorage` 中有 `paperread_username`
- 未登录用户默认为 `guest`
- 建议在用户登录后设置正确的用户名

### 3. 数据迁移
如果之前有语法相关的文章在 `articles` 表中，需要手动迁移：

```python
from articles.models import Article, GrammarArticle

# 迁移示例
grammar_articles = Article.objects.filter(category__icontains='语法')
for article in grammar_articles:
    GrammarArticle.objects.create(
        title=article.title,
        content=article.content,
        source=article.source,
        difficulty=article.difficulty,
        category=article.category,
        author='admin'
    )
```

### 4. 测试建议
- 测试两个tab的切换
- 测试不同用户的数据隔离
- 测试AI生成功能
- 测试搜索和筛选功能

## 📚 相关文档

- [AI生成功能配置说明](./AI生成功能配置说明.md)
- [AI生成功能测试指南](./AI生成功能测试指南.md)
- [DeepSeek集成说明](./DeepSeek集成说明.md)

## 🎯 下一步计划

- [ ] 添加文章模板功能
- [ ] 支持文章导入/导出
- [ ] 添加文章标签系统
- [ ] 支持文章版本控制
- [ ] 添加协作编辑功能

---

**更新日期**：2025-10-25  
**版本**：v1.0

