# 用户系统测试指南

## ✅ 实现内容总览

### 前端实现
1. **个人中心页面** (`profile.html`)
   - ✅ 添加用户名编辑界面
   - ✅ 显示当前用户名和头像
   - ✅ 用户名输入框和保存功能

2. **样式文件** (`profile.css`)
   - ✅ 用户名编辑按钮样式
   - ✅ 编辑区域样式
   - ✅ 输入框和按钮美化

3. **逻辑文件** (`profile.js`)
   - ✅ 用户名管理功能
   - ✅ 显示更新逻辑
   - ✅ 保存验证逻辑

4. **全局工具** (`user-manager.js`)
   - ✅ `getUsername()` - 获取用户名
   - ✅ `setUsername()` - 设置用户名
   - ✅ `getDisplayName()` - 获取显示名称
   - ✅ `getAvatarText()` - 获取头像文字
   - ✅ 访客模式自动生成
   - ✅ 用户提示功能

5. **阅读页面** (`script.js`)
   - ✅ 集成用户名管理
   - ✅ 保存标注时发送用户名
   - ✅ 加载标注时传递用户名

### 后端实现
1. **视图文件** (`articles/views.py`)
   - ✅ `get_user_identifier()` - 获取用户标识
   - ✅ 标注API支持用户名参数
   - ✅ 向后兼容IP模式

## 🧪 测试步骤

### 测试1：设置用户名

**步骤**：
1. 打开 http://localhost:8000/profile.html
2. 观察初始状态：
   - 用户名应显示"访客"
   - 头像应显示"G"
3. 点击"✏️ 编辑用户名"按钮
4. 输入用户名，如"TestUser"
5. 点击"保存"

**预期结果**：
- ✅ 显示成功提示："用户名设置成功！你的标注数据已独立保存"
- ✅ 用户名更新为"TestUser"
- ✅ 头像更新为"TE"
- ✅ 编辑区域自动隐藏

**验证**：
打开浏览器控制台（F12），输入：
```javascript
localStorage.getItem('username')
```
应该显示："TestUser"

---

### 测试2：用户名验证

**测试2.1：空用户名**
1. 点击"编辑用户名"
2. 清空输入框
3. 点击"保存"

**预期**：显示警告"请输入用户名"

**测试2.2：过短用户名**
1. 输入"A"（1个字符）
2. 点击"保存"

**预期**：显示警告"用户名长度应在2-20个字符之间"

**测试2.3：过长用户名**
1. 输入21个字符
2. 点击"保存"

**预期**：显示警告"用户名长度应在2-20个字符之间"

---

### 测试3：标注数据隔离

**步骤**：

**用户A的操作**：
1. 打开个人中心，设置用户名为"UserA"
2. 打开阅读页面 http://localhost:8000/index.html
3. 开启"标注模式"
4. 选择绿色，标注单词"important"
5. 选择黄色，标注单词"technology"
6. 刷新页面

**预期结果**：
- ✅ 标注保存成功
- ✅ 刷新后标注仍然存在
- ✅ important 显示绿色背景
- ✅ technology 显示黄色背景

**用户B的操作**（模拟另一个用户）：
1. 打开控制台，清除用户名：
   ```javascript
   localStorage.removeItem('username')
   ```
2. 刷新页面
3. 打开个人中心，设置用户名为"UserB"
4. 打开同一篇文章
5. 观察标注状态

**预期结果**：
- ✅ 文章没有任何标注（UserA的标注不可见）
- ✅ 侧边栏单词列表为空或无标注颜色

**用户B标注新单词**：
1. 开启"标注模式"
2. 选择红色，标注单词"important"
3. 选择蓝色，标注单词"computer"
4. 刷新页面

**预期结果**：
- ✅ important 显示红色背景
- ✅ computer 显示蓝色背景
- ✅ technology 无标注（因为是UserA标注的）

**切换回用户A**：
1. 打开控制台：
   ```javascript
   localStorage.setItem('username', 'UserA')
   ```
2. 刷新页面

**预期结果**：
- ✅ important 显示绿色背景（UserA的颜色）
- ✅ technology 显示黄色背景
- ✅ computer 无标注（因为是UserB标注的）

---

### 测试4：访客模式

**步骤**：
1. 清除localStorage：
   ```javascript
   localStorage.clear()
   ```
2. 刷新页面
3. 打开个人中心

**预期结果**：
- ✅ 用户名显示"访客"
- ✅ 头像显示"G"
- ✅ 控制台查看 `localStorage.getItem('username')` 应显示类似 "Guest_1234567890_123"

**标注功能**：
1. 打开阅读页面
2. 标注几个单词
3. 刷新页面

**预期结果**：
- ✅ 访客也能保存标注
- ✅ 刷新后标注仍然存在

---

### 测试5：多页面同步

**步骤**：
1. 打开两个浏览器标签
2. 标签1：打开个人中心
3. 标签2：打开阅读页面
4. 在标签1中修改用户名

**预期结果**：
- 用户名在两个标签中都应更新（如果刷新页面）

---

### 测试6：API集成

**测试保存标注API**：

打开浏览器控制台，执行：
```javascript
// 设置用户名
localStorage.setItem('username', 'TestAPI');

// 模拟保存标注
fetch('http://localhost:8000/api/articles/1/save_annotations/', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify({
        annotations: [
            { word: 'test', color: '#ff0000' },
            { word: 'api', color: '#00ff00' }
        ],
        username: 'TestAPI'
    })
})
.then(res => res.json())
.then(data => console.log('保存结果:', data));
```

**预期**：返回 `{status: "annotations saved"}`

**测试加载标注API**：
```javascript
fetch('http://localhost:8000/api/articles/1/annotations/?username=TestAPI')
.then(res => res.json())
.then(data => console.log('加载结果:', data));
```

**预期**：返回标注列表，包含 test 和 api

---

### 测试7：向后兼容性

**测试不带用户名的请求**：
```javascript
fetch('http://localhost:8000/api/articles/1/annotations/')
.then(res => res.json())
.then(data => console.log('IP模式结果:', data));
```

**预期**：应该返回基于IP的标注（如果有的话）

---

## 🐛 常见问题排查

### 问题1：用户名保存后没有更新
**检查**：
- 打开控制台查看是否有JavaScript错误
- 确认 `localStorage.getItem('username')` 有值
- 检查 `user-manager.js` 是否正确加载

### 问题2：标注数据没有隔离
**检查**：
- 确认 `script.js` 中调用了 `getUsername()`
- 查看网络请求是否包含username参数
- 检查后端日志，确认接收到username

### 问题3：刷新后用户名丢失
**检查**：
- localStorage 是否被清除
- 是否在隐私模式下浏览（隐私模式会限制localStorage）

### 问题4：标注保存失败
**检查**：
1. 打开网络面板（Network）
2. 查看保存请求的响应
3. 检查请求体是否包含username字段
4. 查看后端日志

---

## 📊 测试清单

### 功能测试
- [ ] 设置用户名
- [ ] 修改用户名
- [ ] 用户名长度验证
- [ ] 访客模式自动生成ID
- [ ] 头像文字更新
- [ ] 保存成功提示

### 数据隔离测试
- [ ] 不同用户看到不同标注
- [ ] 切换用户后标注切换
- [ ] 访客数据独立保存

### API测试
- [ ] 保存标注带用户名
- [ ] 加载标注带用户名
- [ ] 向后兼容IP模式

### 界面测试
- [ ] 编辑按钮正常显示
- [ ] 编辑区域展开/收起
- [ ] 输入框样式正常
- [ ] 保存/取消按钮工作
- [ ] 成功提示显示

### 兼容性测试
- [ ] Chrome 浏览器
- [ ] Firefox 浏览器
- [ ] Safari 浏览器
- [ ] Edge 浏览器

---

## 🎉 测试完成标准

所有测试项都通过后，用户系统即可正式使用！

**核心验证**：
1. ✅ 能设置用户名
2. ✅ 用户名显示正确
3. ✅ 不同用户标注数据隔离
4. ✅ 刷新后数据保持
5. ✅ API正确传递用户名

---

**开始测试吧！** 🚀

如有问题，请查看控制台日志或后端日志获取详细信息。

